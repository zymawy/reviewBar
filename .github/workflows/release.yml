name: Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: ReviewBar

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Build Release
        run: |
          swift build -c release
          
      - name: Package App
        run: |
          chmod +x ./Scripts/package_app.sh
          REVIEWBAR_SIGNING=adhoc ./Scripts/package_app.sh
          
      - name: Create DMG
        run: |
          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_NAME.app" -ov -format UDZO "$APP_NAME.dmg"
          
      - name: Build CLI (Linux)
        run: |
          # Build CLI for distribution
          swift build -c release --product reviewbar
          mkdir -p dist
          cp .build/release/reviewbar dist/
          cd dist && tar -czf ../ReviewBarCLI-${{ github.ref_name }}-macos.tar.gz reviewbar
          
      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.APP_NAME }} ${{ steps.version.outputs.version }}
          body: |
            ## What's New
            See [CHANGELOG.md](CHANGELOG.md) for details.
            
            ## Installation
            
            ### macOS App
            Download `ReviewBar.dmg`, open it, and drag to Applications.
            
            ### Homebrew
            ```bash
            brew install --cask zymawy/tap/reviewbar
            ```
            
            ### CLI Only
            ```bash
            brew install zymawy/tap/reviewbar
            ```
          files: |
            ${{ env.APP_NAME }}.dmg
            ReviewBarCLI-${{ steps.version.outputs.version }}-macos.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
